<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RadRes Daily</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav>
        <div class="container nav-content">
            <a href="dashboard.html" class="nav-logo" style="text-decoration:none;">üß† RadRes Daily</a>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="cards.html" class="nav-link">Cards</a>
                <a href="study.html" class="nav-link">Study</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
                <a href="#" class="nav-link" id="logoutBtn">Logout</a>
            </div>
        </div>
    </nav>

    <main class="container p-8">
        <header class="flex justify-between items-center animate-fade-in">
            <div>
                <h1 id="welcomeUser">Welcome back, Doctor</h1>
                <p>Here is your daily radiology digest and study plan.</p>
            </div>
            <button class="btn btn-primary" id="startSessionBtn">
                Start Daily Session (20 cards)
            </button>
        </header>

        <div class="dashboard-grid animate-fade-in" style="animation-delay: 0.1s;">

            <!-- Daily Digest Section -->
            <section class="card" style="grid-column: span 2;">
                <h2>üì∞ Daily Digest</h2>
                <div id="digestContent">
                    <p>Loading today's curated updates...</p>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="card">
                <h2>Quick Stats</h2>
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between">
                        <span>Streak</span>
                        <span class="text-success font-bold">12 Days üî•</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Due Today</span>
                        <span class="text-warning font-bold">24 Cards</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Accuracy</span>
                        <span class="text-primary font-bold">84%</span>
                    </div>
                </div>
            </section>

            <!-- Top Radiology Papers/News -->
            <section class="card" style="grid-column: span 3;">
                <h2>Top Radiology Papers/News</h2>
                <div id="topStories" class="flex flex-col gap-4">
                    <!-- Populated by JS -->
                </div>
            </section>

        </div>
    </main>

    <script src="../modules/toon-parser.js"></script>
    <script src="../modules/srs-engine.js"></script>
    <script type="module">
        // Real Identity & Stats Fetching
        const welcomeUser = document.getElementById('welcomeUser');
        const streakEl = document.querySelector('.text-success');
        const dueEl = document.querySelector('.text-warning');
        const accuracyEl = document.querySelector('.text-primary');

        async function initDashboard() {
            const pin = sessionStorage.getItem('radres_pin');
            const headers = pin ? { 'x-radres-pin': pin } : {};

            try {
                // 1. Fetch Identity
                const idRes = await fetch('/api/identity', { headers });
                const idData = await idRes.json();

                if (!idData.authenticated) {
                    window.location.href = '../../index.html';
                    return;
                }

                welcomeUser.innerText = `Welcome back, ${idData.short_name}`;
                document.body.dataset.authMethod = idData.method;

                // 2. Fetch User Stats (From KV)
                const statsRes = await fetch('/api/stats', { headers });
                const stats = await statsRes.json();
                const cardStates = stats.card_states || {};

                // 3. Load Flashcards to calculate real "Due Today"
                const cardsRes = await fetch('../data/flashcards.toon');
                const cardsText = await cardsRes.text();
                const cardsData = TOONParser.parse(cardsText);
                const allCards = cardsData.cards || [];

                const dueCards = SRSEngine.getDueCards(cardStates, allCards, 1000); // Get all due cards to count them

                console.log(`Debug: ${allCards.length} total cards, ${dueCards.length} due.`);

                streakEl.innerText = `${stats.streak || 0} Days üî•`;

                streakEl.innerText = `${stats.streak || 0} Days üî•`;
                dueEl.innerText = `${dueCards.length} Cards`;
                accuracyEl.innerText = `${stats.accuracy || 0}%`;

                // 4. Load News Digest
                loadNews();

            } catch (err) {
                console.error('Initialization error:', err);
                welcomeUser.innerText = 'Welcome back, Doctor (Offline Mode)';
            }
        }

        async function loadNews() {
            const date = new Date().toISOString().split('T')[0];
            const digestPath = `../data/digest/${date}.toon`;

            try {
                const response = await fetch(digestPath);
                if (!response.ok) throw new Error('Digest not found');

                const toonText = await response.text();
                const digestData = TOONParser.parse(toonText);

                const displaySummary = typeof digestData.summary === 'string' ? digestData.summary :
                    (typeof digestData.summary === 'object' ? Object.values(digestData.summary).join(' ') : 'No summary available');

                document.getElementById('digestContent').innerHTML = `
                    <div class="p-4" style="background:rgba(255,255,255,0.05); border-radius:0.5rem;">
                        <h3>${digestData.digest.date} Summary</h3>
                        <p>${displaySummary}</p>
                    </div>
                `;

                const stories = Array.isArray(digestData.top_stories) ? digestData.top_stories : [];
                const storiesHtml = stories.map(s => `
                    <div class="p-4 flex gap-4 items-start" style="background:rgba(255,255,255,0.03); border-radius:0.8rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.05);">
                        ${s.image_url ? `<img src="${s.image_url}" style="width:100px; height:100px; object-fit:cover; border-radius:0.5rem; background:var(--surface);">` :
                        `<div style="width:100px; height:100px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.05); border-radius:0.5rem; font-size:1.5rem;">üì∞</div>`}
                        <div style="flex:1">
                            <div class="flex justify-between">
                                <span style="font-size:0.7rem; color:var(--primary); text-transform:uppercase; letter-spacing:1px; font-weight:700;">${s.category}</span>
                                <span style="font-size:0.7rem; opacity:0.5;">Relevance: ${s.importance || s.relevance_score || 'N/A'}</span>
                            </div>
                            <h4 style="margin:0.25rem 0; font-size:1.1rem; color:var(--text);">${s.title}</h4>
                            <p style="font-size:0.85rem; opacity:0.7; margin:0;">${s.ai_summary || ''}</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('topStories').innerHTML = storiesHtml;

            } catch (e) {
                // Fallback to demo news if JSON not yet generated
                renderDemoNews();
            }
        }

        function renderDemoNews() {
            const todayStr = new Date().toLocaleDateString();
            document.getElementById('digestContent').innerHTML = `
                <div class="p-6 text-center" style="background:rgba(255,255,255,0.02); border-radius:1rem; border: 1px dashed rgba(255,255,255,0.1);">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <h3 style="margin:0;">Digest Incoming</h3>
                    <p style="font-size: 0.9rem; opacity: 0.6;">Today's curated radiology updates are being processed by the AI engine. Check back in a few minutes.</p>
                </div>
            `;

            // Show a "Recently Uploaded" placeholder to verify /img/ path
            document.getElementById('topStories').innerHTML = `
                <div class="p-4" style="background:rgba(37, 99, 235, 0.1); border-radius:1rem; border: 1px solid var(--primary); color: var(--text);">
                    <h4>üöÄ System Ready</h4>
                    <p style="font-size:0.8rem; margin: 0.5rem 0;">All services are now running on Cloudflare. You can start studying or upload new clinical images to your cards.</p>
                    <a href="study.html" class="btn btn-primary" style="font-size:0.8rem; padding: 0.5rem 1rem;">Go to Study Mode</a>
                </div>
            `;
        }

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            const method = document.body.dataset.authMethod;

            if (method === 'pin') {
                sessionStorage.removeItem('radres_pin');
                window.location.href = '../../index.html';
            } else {
                // Clear identity and redirect to Cloudflare logout
                window.location.href = window.location.origin + '/cdn-cgi/access/logout';
            }
        });

        document.getElementById('startSessionBtn').addEventListener('click', () => {
            window.location.href = 'study.html';
        });

        initDashboard();
    </script>
</body>

</html>