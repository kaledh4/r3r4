<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RadRes Daily</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav>
        <div class="container nav-content">
            <div class="nav-logo">ðŸ§  RadRes Daily</div>
            <div class="nav-links">
                <a href="#" class="nav-link active">Dashboard</a>
                <a href="#" class="nav-link">Cards</a>
                <a href="#" class="nav-link">Analytics</a>
                <a href="#" class="nav-link" id="logoutBtn">Logout</a>
            </div>
        </div>
    </nav>

    <main class="container p-8">
        <header class="flex justify-between items-center animate-fade-in">
            <div>
                <h1 id="welcomeUser">Welcome back, Doctor</h1>
                <p>Here is your daily radiology digest and study plan.</p>
            </div>
            <button class="btn btn-primary" id="startSessionBtn">
                Start Daily Session (20 cards)
            </button>
        </header>

        <div class="dashboard-grid animate-fade-in" style="animation-delay: 0.1s;">

            <!-- Daily Digest Section -->
            <section class="card" style="grid-column: span 2;">
                <h2>ðŸ“° Daily Digest</h2>
                <div id="digestContent">
                    <p>Loading today's curated updates...</p>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="card">
                <h2>ðŸ“Š Quick Stats</h2>
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between">
                        <span>Streak</span>
                        <span class="text-success font-bold">12 Days ðŸ”¥</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Due Today</span>
                        <span class="text-warning font-bold">24 Cards</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Accuracy</span>
                        <span class="text-primary font-bold">84%</span>
                    </div>
                </div>
            </section>

            <!-- Top Stories -->
            <section class="card" style="grid-column: span 3;">
                <h2>Top Stories</h2>
                <div id="topStories" class="flex flex-col gap-4">
                    <!-- Populated by JS -->
                </div>
            </section>

        </div>
    </main>

    <script src="../modules/toon-parser.js"></script>
    <script type="module">
        // Real Identity & Stats Fetching
        const welcomeUser = document.getElementById('welcomeUser');
        const streakEl = document.querySelector('.text-success');
        const dueEl = document.querySelector('.text-warning');
        const accuracyEl = document.querySelector('.text-primary');

        async function initDashboard() {
            const pin = sessionStorage.getItem('radres_pin');
            const headers = pin ? { 'x-radres-pin': pin } : {};

            try {
                // 1. Fetch Identity
                const idRes = await fetch('/api/identity', { headers });
                const idData = await idRes.json();

                if (!idData.authenticated) {
                    window.location.href = '../../index.html';
                    return;
                }

                welcomeUser.innerText = `Welcome back, ${idData.short_name}`;
                document.body.dataset.authMethod = idData.method;

                // 2. Fetch User Stats (From KV)
                const statsRes = await fetch('/api/stats', { headers });
                const stats = await statsRes.json();

                streakEl.innerText = `${stats.streak || 0} Days ðŸ”¥`;
                dueEl.innerText = `${stats.due_today || 0} Cards`;
                accuracyEl.innerText = `${stats.accuracy || 0}%`;

                // 3. Load News Digest
                loadNews();

            } catch (err) {
                console.error('Initialization error:', err);
                welcomeUser.innerText = 'Welcome back, Doctor (Offline Mode)';
            }
        }

        async function loadNews() {
            const date = new Date().toISOString().split('T')[0];
            const digestPath = `../data/digest/${date}.toon`;

            try {
                const response = await fetch(digestPath);
                if (!response.ok) throw new Error('Digest not found');

                const toonText = await response.text();
                const digestData = TOONParser.parse(toonText);

                document.getElementById('digestContent').innerHTML = `
                    <div class="p-4" style="background:rgba(255,255,255,0.05); border-radius:0.5rem;">
                        <h3>${digestData.digest.date} Summary</h3>
                        <p>${digestData.summary}</p>
                    </div>
                `;

                const stories = Array.isArray(digestData.top_stories) ? digestData.top_stories : [];
                const storiesHtml = stories.map(s => `
                    <div class="p-4 flex justify-between items-center" style="background:rgba(255,255,255,0.03); border-radius:0.5rem;">
                        <div>
                            <span style="font-size:0.8rem; color:var(--primary); text-transform:uppercase;">${s.category}</span>
                            <h4 style="margin:0.25rem 0;">${s.title}</h4>
                            <p style="font-size:0.8rem; opacity:0.7;">${s.ai_summary || ''}</p>
                        </div>
                        <div style="background:var(--surface); padding:0.25rem 0.5rem; border-radius:1rem; font-size:0.8rem;">
                            Relevance: ${s.importance || s.relevance_score || 'N/A'}
                        </div>
                    </div>
                `).join('');
                document.getElementById('topStories').innerHTML = storiesHtml;

            } catch (e) {
                // Fallback to demo news if JSON not yet generated
                renderDemoNews();
            }
        }

        function renderDemoNews() {
            const todayStr = new Date().toLocaleDateString();
            document.getElementById('digestContent').innerHTML = `
                <div class="p-4" style="background:rgba(255,255,255,0.05); border-radius:0.5rem;">
                    <h3>${todayStr} Summary (Live Feed Loading...)</h3>
                    <p>Fetching the latest radiology updates. If this persists, the daily curation script is still running.</p>
                </div>
            `;
            // ... (keep stories mock if needed or leave empty)
        }

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            const method = document.body.dataset.authMethod;

            if (method === 'pin') {
                sessionStorage.removeItem('radres_pin');
                window.location.href = '../../index.html';
            } else {
                // Clear identity and redirect to Cloudflare logout
                window.location.href = window.location.origin + '/cdn-cgi/access/logout';
            }
        });

        document.getElementById('startSessionBtn').addEventListener('click', () => {
            window.location.href = 'study.html';
        });

        initDashboard();
    </script>
</body>

</html>